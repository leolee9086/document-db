(function(c,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(c=typeof globalThis<"u"?globalThis:c||self,f(c.DocumentDB={}))})(this,function(c){"use strict";const f=n=>typeof n=="string"?n.startsWith("data:image/")?"base64":n.startsWith("{")||n.startsWith("[")?"json":"string":typeof n=="number"?"number":typeof n=="boolean"?"boolean":n===null||n===void 0?"null":"json",J=(n,t,e)=>{let r="";switch(e){case"json":r=JSON.stringify(t);break;case"base64":case"string":r=String(t);break;case"number":case"boolean":r=String(t);break;case"null":r="";break;default:r=JSON.stringify(t)}n.textContent!==r&&(n.textContent=r)},g=(n,t)=>{switch(t){case"json":try{return JSON.parse(n)}catch{return n}case"number":return Number(n);case"boolean":return n==="true";case"null":return null;case"base64":case"string":default:return n}},W=(n,t)=>{let e=n.getElementById(t);if(!e){e=n.createElement("span"),e.id=t,e.style.display="none";const r=n.createDocumentFragment();r.appendChild(e),n.body.appendChild(r)}return e},Y=(n,t,e)=>{let r=n.querySelector(`[data-key="${e}"]`);return r||(r=t.createElement("span"),r.setAttribute("data-key",e),r.style.display="none",n.appendChild(r)),r},w=new WeakMap,p=(n,t="document-db")=>{const e=W(n,t),r={document:n,rootId:t,root:e,transactionStack:[],isInTransaction:!1};return w.set(n,r),r},u=n=>w.get(n),S=(n,t,e,r,o,a)=>{const s=Y(n.root,n.document,t),l={"data-type":r,"data-version":o,"data-created":new Date().toISOString()};Object.entries(a).forEach(([i,d])=>{l[`data-${i}`]=String(d)}),Object.entries(l).forEach(([i,d])=>{s.setAttribute(i,d)}),J(s,e,r)},C=(n,t)=>{const e=n.root.querySelector(`[data-key="${t}"]`);e&&e.remove()},k=n=>{const t=n.root.querySelectorAll("[data-key]");if(t.length>0){const e=n.document.createDocumentFragment();t.forEach(r=>e.appendChild(r))}},h=(n,t,e,r={})=>{const o=u(n);if(!o)throw new Error("DocumentDB state not found");const{type:a="auto",version:s="1.0",...l}=r,i=a==="auto"?f(e):a||"string";o.isInTransaction?o.transactionStack[o.transactionStack.length-1].operations.push({type:"set",key:t,value:e,detectedType:i,version:s,meta:l}):S(o,t,e,i,s,l)},T=(n,t,e=null)=>{const r=u(n);if(!r)return e;const o=r.root.querySelector(`[data-key="${t}"]`);if(!o)return e;const a=o.getAttribute("data-type"),s=o.textContent?.trim()||"";return g(s,a)},A=(n,t)=>{const e=u(n);if(!e)throw new Error("DocumentDB state not found");e.isInTransaction?e.transactionStack[e.transactionStack.length-1].operations.push({type:"delete",key:t}):C(e,t)},B=(n,t)=>{const e=u(n);return e?e.root.querySelector(`[data-key="${t}"]`)!==null:!1},I=n=>{const t=u(n);if(!t)return[];const e=t.root.querySelectorAll("[data-key]");return Array.from(e).map(r=>r.getAttribute("data-key")||"")},E=n=>{const t=u(n);if(!t)throw new Error("DocumentDB state not found");t.isInTransaction?t.transactionStack[t.transactionStack.length-1].operations.push({type:"clear"}):k(t)},L=n=>{const t=u(n);if(!t)throw new Error("DocumentDB state not found");const e=`tx_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r={id:e,operations:[],snapshot:z(t),startTime:Date.now()};return t.transactionStack.push(r),t.isInTransaction=!0,e},M=(n,t)=>{const e=u(n);if(!e)return!1;const r=x(e,t);if(!r)return!1;for(const o of r.operations)Q(e,o);return R(e,t),!0},H=(n,t)=>{const e=u(n);if(!e)return!1;const r=x(e,t);return r?(G(e,r.snapshot),R(e,t),!0):!1},O=n=>{const t=u(n);return t?{isInTransaction:t.isInTransaction,activeTransactions:t.transactionStack.length,transactionIds:t.transactionStack.map(e=>e.id)}:{isInTransaction:!1,activeTransactions:0,transactionIds:[]}},j=n=>{const t=u(n);return t?t.isInTransaction:!1},q=(n,t)=>{const e=u(n);if(!e||!e.isInTransaction)return null;const r=e.transactionStack[e.transactionStack.length-1];if(!r)return null;for(let o=r.operations.length-1;o>=0;o--){const a=r.operations[o];if(a.type==="set"&&a.key===t)return a.value;if(a.type==="delete"&&a.key===t)return null}return T(n,t)},F=(n,t,e)=>{const r=u(n);if(!r||!r.isInTransaction)return!1;const o=r.transactionStack[r.transactionStack.length-1];return o?(o.operations.push({type:"set",key:t,value:e,detectedType:f(e),version:"1.0",meta:{}}),!0):!1},x=(n,t)=>n.transactionStack.find(e=>e.id===t),R=(n,t)=>{const e=n.transactionStack.findIndex(r=>r.id===t);e!==-1&&(n.transactionStack.splice(e,1),n.isInTransaction=n.transactionStack.length>0)},z=n=>{const t={};return n.root.querySelectorAll("[data-key]").forEach(r=>{const o=r.getAttribute("data-key"),a=r.getAttribute("data-type"),s=r.textContent?.trim()||"",l=g(s,a);o&&(t[o]={value:l,type:a||"string"})}),t},G=(n,t)=>{k(n),Object.entries(t).forEach(([e,{value:r,type:o}])=>{S(n,e,r,o,"1.0",{})})},Q=(n,t)=>{switch(t.type){case"set":t.key&&t.detectedType&&S(n,t.key,t.value,t.detectedType,t.version||"1.0",t.meta||{});break;case"delete":t.key&&C(n,t.key);break;case"clear":k(n);break}},$=n=>{const t=u(n);return t?t.root.outerHTML:""},v=(n,t={})=>{const e=u(n);if(!e)return"";const{title:r="DocumentDB Export",charset:o="UTF-8"}=t,a=n.implementation.createHTMLDocument(r);let s=a.querySelector("meta[charset]");s?s.setAttribute("charset",o):(s=a.createElement("meta"),s.setAttribute("charset",o),a.head.insertBefore(s,a.head.firstChild)),a.title=r;const l=a.createElement("style");l.textContent=`
#${e.rootId} { display: none !important; }
#${e.rootId} [data-key] { display: none !important; }
`,a.head.appendChild(l),a.body.innerHTML=n.body.innerHTML;let i=a.getElementById(e.rootId);return i||(i=a.createElement("span"),i.id=e.rootId,i.style.display="none",a.body.appendChild(i)),i.innerHTML=e.root.innerHTML,`<!DOCTYPE html>
`+a.documentElement.outerHTML},N=(n,t)=>{const e=u(n);if(!e)throw new Error("DocumentDB state not found");const a=new DOMParser().parseFromString(t,"text/html").getElementById(e.rootId);a&&(E(n),a.querySelectorAll("[data-key]").forEach(s=>{const l=s.getAttribute("data-key"),i=s.getAttribute("data-type"),d=s.textContent?.trim()||"",y=g(d,i);l&&h(n,l,y,{type:i||"auto"})}))},P=n=>{const t=u(n);if(!t)throw new Error("DocumentDB state not found");const e=n.cloneNode(!0);return p(e,t.rootId)},K=async(n,t={})=>{try{const{filename:e=`document-db-${Date.now()}.html`,includeDBRoot:r=!0,customStyles:o=""}=t,a=V(n,r,o);return X(a,e,"text/html")}catch{return!1}},V=(n,t,e)=>{const r=n.cloneNode(!0);if(t){const s=u(n);if(!s)throw new Error("DocumentDB state not found");p(r,s.rootId);const l=I(n);for(const i of l){const d=T(n,i);d!==null&&h(r,i,d)}}else{const s=u(n);if(s){const l=r.getElementById(s.rootId);l&&l.remove()}}if(e){const s=r.head,l=r.createElement("style");l.textContent=e,s.appendChild(l)}const o="<!DOCTYPE html>",a=r.documentElement.outerHTML;return o+`
`+a},X=(n,t,e)=>{try{const r=new Blob([n],{type:e}),o=URL.createObjectURL(r),a=document.createElement("a");return a.href=o,a.download=t,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),!0}catch(r){return console.error("下载文件失败:",r),!1}},U=async(n,t={})=>{try{const{clearExisting:e=!0}=t,r=n.createElement("input");return r.type="file",r.accept=".html,.htm",r.style.display="none",new Promise(o=>{r.onchange=async a=>{const l=a.target.files?.[0];if(!l){o(!1);return}try{const i=await Z(l),d=_(n,i,e);o(d)}catch(i){console.error("加载HTML文件失败:",i),o(!1)}finally{n.body.removeChild(r)}},r.click()})}catch(e){return console.error("选择文件失败:",e),!1}},Z=n=>new Promise((t,e)=>{const r=new FileReader;r.onload=o=>{const a=o.target?.result;t(a)},r.onerror=e,r.readAsText(n)}),_=(n,t,e)=>{try{const a=new DOMParser().parseFromString(t,"text/html").querySelector('[id*="document-db"]');if(!a)return console.warn("未找到DocumentDB根元素"),!1;const s=u(n);if(!s)return console.error("当前文档没有DocumentDB状态"),!1;e&&(s.root.innerHTML="");const l=a.querySelectorAll("[data-key]");for(const i of l){const d=i.getAttribute("data-key"),y=i.getAttribute("data-type"),m=i.textContent;if(d&&m!==null){let D=m;if(y==="json")try{D=JSON.parse(m)}catch{D=m}else y==="number"?D=Number(m):y==="boolean"&&(D=m==="true");h(n,d,D)}}return!0}catch(r){return console.error("解析HTML失败:",r),!1}};class b{constructor(t,e="document-db"){this.document=t;const r=u(t);r&&r.rootId===e?this.state=r:this.state=p(t,e)}getState(){return this.state}getRootId(){return this.state.rootId}setData(t,e){h(this.document,t,e)}getData(t){return T(this.document,t)}hasData(t){return B(this.document,t)}deleteData(t){A(this.document,t)}listDataKeys(){return I(this.document)}clearData(){E(this.document)}beginTransaction(){return L(this.document)}commitTransaction(t){return M(this.document,t)}rollbackTransaction(t){return H(this.document,t)}isInTransaction(){return j(this.document)}getTransactionData(t){return q(this.document,t)}setTransactionData(t,e){return F(this.document,t,e)}exportDatabase(){return $(this.document)}exportDocument(t){return v(this.document,t)}importDatabase(t){N(this.document,t)}cloneDatabase(t){const e=P(this.document);return e?new b(t,e.rootId):null}async saveAsHTML(t={}){return K(this.document,t)}async loadFromHTML(t={}){return U(this.document,t)}getInfo(){return{rootId:this.state.rootId,dataCount:this.listDataKeys().length,isInTransaction:this.isInTransaction(),keys:this.listDataKeys()}}destroy(){if(this.isInTransaction()){const e=O(this.document);e.transactionIds.length>0&&this.rollbackTransaction(e.transactionIds[e.transactionIds.length-1])}this.clearData();const t=this.document.getElementById(this.state.rootId);t&&t.remove()}static fromDocument(t){const e=u(t);return e?new b(t,e.rootId):null}static hasDocumentDB(t){return u(t)!==null}}c.DocumentDB=b,c.beginTransaction=L,c.clearData=E,c.cloneDatabase=P,c.commitTransaction=M,c.createDocumentDBState=p,c.deleteData=A,c.exportDatabase=$,c.exportDocument=v,c.getData=T,c.getDocumentDBState=u,c.getTransactionData=q,c.getTransactionStatus=O,c.hasData=B,c.importDatabase=N,c.isInTransaction=j,c.listDataKeys=I,c.loadFromHTML=U,c.rollbackTransaction=H,c.saveAsHTML=K,c.setData=h,c.setTransactionData=F,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
